Crude={Models:{},Views:{},Collections:{},vent:_.extend({},Backbone.Events),trans:{},data:{}},app=new Backbone.Marionette.Application,app.addInitializer(function(t){Backbone.history.start()}),$(function(){app.start()}),Crude.getData=function(t,e){return _.isUndefined("undefined")&&(e=null),_.isUndefined(this.data[t])?e:this.data[t]},Crude.getTrans=function(t,e){return _.isUndefined(e)?_.isUndefined(this.trans[t])?t:this.trans[t]:_.isUndefined(this.trans[t][e])?String(t)+String(e):this.trans[t][e]},Crude.showAlert=function(t,e){if(""!=String(e)){jQuery.inArray(t,["info","danger","warning","success"])||(t="info");var i=_.template($("#crude_alertTemplate").html());$("#crude_alertContainer").find("#alertList").append(i({type:t,msg:e}))}},Crude.clearAllAlerts=function(){$("#crude_alertContainer").find("#alertList").empty()},Crude.showModal=function(t,e,i){""==t&&(t="&nbsp;");var a=_.template($("#crude_modalTemplate").html());$("#crude_modalContainer").html(a({title:t,content:e,btnList:i}));var n=$("#crude_modalContainer").find("#modalFade");n.find(".modal-footer");return n.modal("show"),n.on("shown.bs.modal",function(t){n.find(".btn:first").focus()}),n.on("hidden.bs.modal",function(t){n.off("hidden.bs.modal"),n.remove()}),n},Crude.getFormValues=function(t){var e={};return t.each(function(){var t=$(this);e[t.data("attr")]="checkbox"==t.attr("type")?t.is(":checked"):t.val()}),e},Crude.getAttrName=function(t){return Crude.getTrans("validation.attributes",t)},Crude.renderInput=function(t,e,i){var a="#crude_textInputTemplate",n=t.inputType[e],r=_.isUndefined(n)?a:"#crude_"+n+"InputTemplate",s=$(r);0==s.lenght&&(s=$(a));var o=_.template($(r).html());return o({section:t,attr:e,model:i})},Crude.Models.Base=Backbone.Model.extend({parse:function(t,e){return t.data&&t.data.model?t.data.model:t},getLatLngObject:function(){return{lat:parseFloat(this.get("lat")),lng:parseFloat(this.get("lng"))}}}),Crude.Collections.Base=Backbone.Collection.extend({sort:{attr:"id",order:"asc"},pagination:{page:1,numRows:20,numPages:1,count:0},search:{attr:"id",value:""},changeSortOptions:function(t){return this.sort.attr==t?void(this.sort.order="asc"==this.sort.order?"desc":"asc"):(this.sort.attr=t,void(this.sort.order="asc"))},fetchWithOptions:function(){return this.fetch({data:{sortAttr:this.sort.attr,sortOrder:this.sort.order,page:this.pagination.page,numRows:this.pagination.numRows,searchAttr:this.search.attr,searchValue:this.search.value}})},parse:function(t,e){return t.data?(t.data.sort&&(this.sort=t.data.sort),t.data.pagination&&(this.pagination=t.data.pagination),t.data.search&&(this.search=t.data.search),t.data.collection?t.data.collection:void 0):t}}),Crude.Models.setup=Backbone.Model.extend({idAttribute:"name",defaults:{name:null,column:[],addForm:[],editForm:[],inputType:[],actions:[],deleteOption:!0,actionToTrigger:[],config:[]},getName:function(){return this.get("name")},config:function(t){var e=this.get("config");return e[t]},apiRoute:function(){return this.config("routePrefix")+"/api/"+this.getName()},getNewCollection:function(){var t=this.apiRoute(),e=Crude.Models.Base.extend({urlRoot:t}),i=Crude.Collections.Base.extend({model:e,url:t});return new i},getNewModel:function(){var t=this.apiRoute(),e=Crude.Models.Base.extend({urlRoot:t});return new e},isActionAvailable:function(t){return-1!=_.indexOf(this.get("actions"),t)},getNextAction:function(t){var e=_.indexOf(this.get("actions"),t)+1,i=this.get("actions")[e];return _.isUndefined(i)?"":i},triggerAction:function(t,e){_.isArray(t)||(t=[t]),this.set("actionToTrigger",t),Crude.vent.trigger("action_end",this.getName()),this.triggerNextAction(e)},triggerNextAction:function(t){Crude.vent.trigger("item_selected");var e=this.get("actionToTrigger");if(0==e.length)return void this.triggerCancel();var i=e[0];e.shift(),Crude.vent.trigger("action_end",this.getName()),Crude.vent.trigger("action_"+i,this.getName(),t)},triggerCancel:function(){Crude.vent.trigger("action_end",this.getName()),Crude.vent.trigger("action_update",this.getName())}}),Crude.Views.ListItem=Backbone.Marionette.ItemView.extend({template:"#crude_listItemTemplate",tagName:"tr",className:function(){return Crude.data.selectedItem==this.model.get("id")?"active":""},ui:{action:".action","delete":"#delete"},events:{"click @ui.action":"action","click @ui.delete":"delete"},initialize:function(t){this.setup=t.setup,this.listenTo(Crude.vent,"item_selected",this.itemSelected)},serializeData:function(){return{model:this.model,setup:this.setup}},action:function(t){Crude.data.selectedItem=this.model.get("id");var e=$(t.target).data("action");this.setup.triggerAction(e,this.model)},itemSelected:function(t){this.setup.getName()==t&&(this.model.get("id")==Crude.data.selectedItem?this.$el.addClass("active"):this.$el.removeClass("active"))},"delete":function(){$modal=Crude.showModal(Crude.getTrans("admin.confirm_delete","title"),Crude.getTrans("admin.confirm_delete","content"),{cancel:Crude.getTrans("admin.confirm_delete","cancel"),"delete":Crude.getTrans("admin.confirm_delete","confirm")}),$modal.find('[data-key="delete"]').bind("click",function(t){this.model.destroy({wait:!0}).done(function(t){"message"in t&&Crude.showAlert("success",t.message),$modal.modal("hide")}.bind(this)).fail(function(t){var e=JSON.parse(t.responseText);422==t.status&&(errors=_.values(e).join("<br>"),Crude.showAlert("danger",errors)),403==t.status&&Crude.showAlert("danger",e.error.message),$modal.modal("hide"),this.setup.triggerCancel()}.bind(this))}.bind(this))}}),Crude.Views.ListEmpty=Backbone.Marionette.ItemView.extend({template:"#crude_listEmptyTemplate",tagName:"tr",initialize:function(t){this.setup=t.setup},serializeData:function(){return{setup:this.setup}}}),Crude.Views.List=Backbone.Marionette.CompositeView.extend({template:"#crude_listTemplate",childView:Crude.Views.ListItem,emptyView:Crude.Views.ListEmpty,childViewContainer:"#childViewContainer",ui:{add:"#add",sort:".sort",changeNumRows:".changeNumRows",changePage:".changePage",changeSearchAttr:".changeSearchAttr",searchValue:"#searchValue",search:"#search",selectedSearchAttr:"#selectedSearchAttr",clearSearch:"#clearSearch"},events:{"click @ui.add":"add","click @ui.sort":"sort","click @ui.changeNumRows":"changeNumRows","click @ui.changePage":"changePage","click @ui.changeSearchAttr":"changeSearchAttr","click @ui.search":"search","click @ui.clearSearch":"clearSearch"},initialize:function(t){this.setup=t.setup,this.collection=this.setup.getNewCollection(),this.updateList(),this.listenTo(Crude.vent,"action_update",this.updateThisList)},childViewOptions:function(){return{setup:this.setup}},serializeData:function(){return{setup:this.setup,sort:this.collection.sort,pagination:this.collection.pagination,search:this.collection.search}},add:function(){Crude.data.selectedItem=null,this.setup.triggerAction(_.clone(this.setup.get("actions")),this.setup.getNewModel())},sort:function(t){var e=$(t.target);e.hasClass("sort")||(e=e.parents(".sort")),this.collection.changeSortOptions(e.data("attr")),this.updateList()},changeNumRows:function(t){var e=$(t.target);this.collection.pagination.numRows=e.html(),this.updateList()},changePage:function(){var t=$(event.target);this.collection.pagination.page=t.html(),this.updateList()},changeSearchAttr:function(t){var e=$(t.target);this.collection.search.attr=e.data("attr"),this.ui.selectedSearchAttr.html(e.html())},search:function(){this.collection.search.value=this.ui.searchValue.val(),this.updateList()},clearSearch:function(){this.collection.search.attr="id",this.collection.search.value="",this.updateList()},updateList:function(){this.collection.fetchWithOptions().done(function(){Crude.data.selectedItem=null,this.render()}.bind(this))},updateThisList:function(t){this.setup.getName()==t&&this.updateList()}});